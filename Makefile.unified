SHELL := /usr/bin/env bash

# Load unified environment
ifneq (,$(wildcard .env.unified))
include .env.unified
export
endif

# Utilise le systÃ¨me natif AURA existant
DC := docker compose
PROJECT_NAME := aura-osint-ecosystem

.PHONY: help setup up down restart logs status clean reset health test-all

help: ## Affiche cette aide
	@echo "ðŸš€ AURA OSINT UNIFIED COMMANDS"
	@echo "================================"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

setup: ## Installation complÃ¨te de l'Ã©cosystÃ¨me
	@echo "ðŸ”§ Setup AURA OSINT Ecosystem..."
	@cp .env.unified .env
	@$(DC) pull
	@$(DC) build --no-cache
	@$(DC) up -d
	@echo "â³ Attente initialisation services..."
	@sleep 30
	@$(MAKE) health
	@echo "âœ… Setup terminÃ©!"
	@$(MAKE) status

up: ## DÃ©marre tous les services
	@echo "ðŸš€ DÃ©marrage services AURA OSINT..."
	@$(DC) up -d
	@echo "â³ Attente services..."
	@sleep 15
	@$(MAKE) health

down: ## ArrÃªte tous les services
	@echo "ðŸ›‘ ArrÃªt services AURA OSINT..."
	@$(DC) down

restart: ## RedÃ©marre tous les services
	@echo "ðŸ”„ RedÃ©marrage services..."
	@$(DC) restart

logs: ## Affiche les logs en temps rÃ©el
	@$(DC) logs -f --tail=100

status: ## Statut des services
	@echo "ðŸ“Š Statut des services:"
	@$(DC) ps
	@echo ""
	@echo "ðŸŒ URLs d'accÃ¨s:"
	@echo "  - Frontend:      http://localhost:$(FRONTEND_PORT)"
	@echo "  - Backend API:   http://localhost:$(API_PORT)"
	@echo "  - Live Tracker:  http://localhost:$(LIVE_TRACKER_PORT)"
	@echo "  - Kibana:        http://localhost:$(KIBANA_PORT)"
	@echo "  - SearXNG:       http://localhost:$(SEARXNG_PORT)"
	@echo "  - Grafana:       http://localhost:$(GRAFANA_PORT)"
	@echo "  - Prometheus:    http://localhost:$(PROMETHEUS_PORT)"

health: ## VÃ©rification santÃ© des services
	@echo "ðŸ¥ Health Check..."
	@echo -n "PostgreSQL: "
	@$(DC) exec -T postgres pg_isready -U $(POSTGRES_USER) -d $(POSTGRES_DB) >/dev/null 2>&1 && echo "âœ… OK" || echo "âŒ KO"
	@echo -n "Redis: "
	@$(DC) exec -T redis redis-cli auth $(REDIS_PASSWORD) ping >/dev/null 2>&1 && echo "âœ… OK" || echo "âŒ KO"
	@echo -n "Elasticsearch: "
	@curl -fsS http://localhost:$(ELASTIC_PORT)/_cluster/health >/dev/null 2>&1 && echo "âœ… OK" || echo "âŒ KO"
	@echo -n "SearXNG: "
	@curl -fsS "http://localhost:$(SEARXNG_PORT)/search?q=test&format=json" >/dev/null 2>&1 && echo "âœ… OK" || echo "âŒ KO"
	@echo -n "Backend API: "
	@curl -fsS http://localhost:$(API_PORT)/health >/dev/null 2>&1 && echo "âœ… OK" || echo "âŒ KO"

db-shell: ## AccÃ¨s shell PostgreSQL
	@$(DC) exec postgres psql -U $(POSTGRES_USER) -d $(POSTGRES_DB)

redis-shell: ## AccÃ¨s shell Redis
	@$(DC) exec redis redis-cli -a $(REDIS_PASSWORD)

# === OSINT OPERATIONS ===
osint-recon: ## Reconnaissance OSINT sur un domaine
	@test -n "$(DOMAIN)" || (echo "Usage: make osint-recon DOMAIN=example.com"; exit 1)
	@echo "ðŸ” Reconnaissance OSINT: $(DOMAIN)"
	@$(DC) exec aura-backend node scripts/osint-recon.js $(DOMAIN)

osint-dorks: ## ExÃ©cute des dorks Google
	@test -n "$(QUERY)" || (echo "Usage: make osint-dorks QUERY='site:example.com'"; exit 1)
	@echo "ðŸŽ¯ Google Dorks: $(QUERY)"
	@$(DC) exec aura-backend node scripts/osint-dorks.js "$(QUERY)"

osint-ner: ## Analyse NER sur un texte
	@test -n "$(TEXT)" || (echo "Usage: make osint-ner TEXT='Jean Martin travaille chez ACME'"; exit 1)
	@echo "ðŸ§  Analyse NER: $(TEXT)"
	@$(DC) exec aura-backend python3 services/ner-french-enhanced.py "$(TEXT)"

# === DEVELOPMENT ===
dev-backend: ## Mode dÃ©veloppement backend
	@$(DC) exec aura-backend npm run dev

dev-frontend: ## Mode dÃ©veloppement frontend
	@$(DC) exec aura-frontend npm start

test-all: ## Lance tous les tests
	@echo "ðŸ§ª Tests complets..."
	@$(DC) exec aura-backend npm test
	@$(DC) exec aura-frontend npm test -- --watchAll=false
	@$(MAKE) health

# === MAINTENANCE ===
clean: ## Nettoie les containers et volumes
	@echo "ðŸ§¹ Nettoyage..."
	@$(DC) down -v --remove-orphans
	@docker system prune -f

reset: ## Reset complet (ATTENTION: perte de donnÃ©es)
	@echo "âš ï¸  RESET COMPLET - Perte de toutes les donnÃ©es!"
	@read -p "Confirmer (y/N): " confirm && [ "$$confirm" = "y" ]
	@$(DC) down -v --remove-orphans
	@docker volume prune -f
	@$(MAKE) setup

backup-db: ## Sauvegarde base de donnÃ©es
	@echo "ðŸ’¾ Sauvegarde DB..."
	@mkdir -p ./backups
	@$(DC) exec -T postgres pg_dump -U $(POSTGRES_USER) $(POSTGRES_DB) > ./backups/aura-db-$(shell date +%Y%m%d-%H%M%S).sql
	@echo "âœ… Sauvegarde: ./backups/aura-db-$(shell date +%Y%m%d-%H%M%S).sql"

restore-db: ## Restaure base de donnÃ©es
	@test -n "$(BACKUP)" || (echo "Usage: make restore-db BACKUP=./backups/aura-db-20250101-120000.sql"; exit 1)
	@echo "ðŸ“¥ Restauration DB: $(BACKUP)"
	@$(DC) exec -T postgres psql -U $(POSTGRES_USER) -d $(POSTGRES_DB) < $(BACKUP)

# === MONITORING ===
metrics: ## Affiche mÃ©triques systÃ¨me
	@echo "ðŸ“Š MÃ©triques systÃ¨me:"
	@$(DC) exec prometheus promtool query instant 'up'
	@echo ""
	@echo "ðŸ” MÃ©triques OSINT:"
	@curl -s http://localhost:$(API_PORT)/metrics | grep osint

benchmark: ## Benchmark performance
	@echo "âš¡ Benchmark performance..."
	@$(DC) exec aura-backend node scripts/benchmark.js

# === SECURITY ===
security-scan: ## Scan sÃ©curitÃ©
	@echo "ðŸ›¡ï¸  Scan sÃ©curitÃ©..."
	@$(DC) exec aura-backend npm audit
	@$(DC) exec aura-frontend npm audit

update-deps: ## Met Ã  jour les dÃ©pendances
	@echo "ðŸ“¦ Mise Ã  jour dÃ©pendances..."
	@$(DC) exec aura-backend npm update
	@$(DC) exec aura-frontend npm update