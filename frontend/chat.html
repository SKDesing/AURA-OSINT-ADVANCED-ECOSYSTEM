<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA OSINT - Chat IA Qwen</title>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Animate.css pour les animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- CSS Golden Ratio Theme -->
    <link rel="stylesheet" href="../DOCUMENTATION TECHNIQUE INTERACTIVE/assets/css/sweetalert-golden-theme.css">
    
    <style>
        :root {
            --phi: 1.618;
            --primary: #0a0e27;
            --secondary: #1a1f3a;
            --accent: #ffd700;
            --text: #ffffff;
            --error: #ff4757;
            --success: #2ed573;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: calc(1rem * var(--phi));
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: calc(1.5rem * var(--phi));
            font-weight: bold;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-indicator {
            width: calc(10px * var(--phi));
            height: calc(10px * var(--phi));
            border-radius: 50%;
            background: var(--error);
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected { 
            background: var(--success);
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: calc(1200px / var(--phi));
            margin: 0 auto;
            width: 100%;
            padding: calc(1rem * var(--phi));
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: calc(1rem * var(--phi));
            background: rgba(0, 0, 0, 0.2);
            border-radius: calc(8px * var(--phi-inverse));
            margin-bottom: calc(1rem * var(--phi));
            backdrop-filter: blur(10px);
        }
        
        .message {
            margin-bottom: calc(1rem * var(--phi));
            display: flex;
            flex-direction: column;
            animation: fadeInUp 0.3s ease-out;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user { align-items: flex-end; }
        .message.assistant { align-items: flex-start; }
        
        .message-content {
            max-width: calc(80% / var(--phi));
            padding: calc(0.75rem * var(--phi)) calc(1rem * var(--phi));
            border-radius: calc(8px * var(--phi-inverse));
            word-wrap: break-word;
            position: relative;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, var(--accent), #ffcc00);
            color: var(--primary);
            border-bottom-right-radius: 0;
        }
        
        .message.assistant .message-content {
            background: rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 0;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .message-info {
            font-size: calc(0.8rem / var(--phi));
            opacity: 0.7;
            margin-top: calc(0.25rem * var(--phi));
        }
        
        .tools-used {
            margin-top: calc(0.5rem * var(--phi));
            padding: calc(0.5rem * var(--phi));
            background: rgba(255, 215, 0, 0.1);
            border-radius: calc(8px * var(--phi-inverse));
            font-size: calc(0.9rem / var(--phi));
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .tools-used h4 {
            margin-bottom: calc(0.5rem * var(--phi));
            color: var(--accent);
            font-size: calc(1rem * var(--phi-inverse));
        }
        
        .tool-result {
            margin-bottom: calc(0.5rem * var(--phi));
            padding: calc(0.5rem * var(--phi));
            background: rgba(0, 0, 0, 0.2);
            border-radius: calc(4px * var(--phi-inverse));
            border-left: 3px solid var(--accent);
        }
        
        .confidence-score {
            display: inline-block;
            padding: calc(0.25rem * var(--phi)) calc(0.5rem * var(--phi));
            background: var(--success);
            color: white;
            border-radius: calc(12px * var(--phi-inverse));
            font-size: calc(0.8rem / var(--phi));
            font-weight: bold;
            margin-left: calc(0.5rem * var(--phi));
        }
        
        .input-container {
            display: flex;
            gap: calc(0.5rem * var(--phi));
            align-items: flex-end;
        }
        
        .message-input {
            flex: 1;
            padding: calc(0.75rem * var(--phi));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: calc(8px * var(--phi-inverse));
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
            font-size: calc(1rem * var(--phi-inverse));
            resize: vertical;
            min-height: calc(2.5rem * var(--phi));
            max-height: calc(6rem * var(--phi));
        }
        
        .message-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
            outline: none;
        }
        
        .send-button {
            padding: calc(0.75rem * var(--phi)) calc(1.5rem * var(--phi));
            background: linear-gradient(135deg, var(--accent), #ffcc00);
            color: var(--primary);
            border: none;
            border-radius: calc(8px * var(--phi-inverse));
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: calc(4rem * var(--phi));
        }
        
        .send-button:hover {
            background: linear-gradient(135deg, #ffcc00, var(--accent));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }
        
        .send-button:disabled {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
        }
        
        .typing-indicator {
            display: none;
            padding: calc(0.75rem * var(--phi)) calc(1rem * var(--phi));
            background: rgba(255, 255, 255, 0.1);
            border-radius: calc(8px * var(--phi-inverse));
            margin-bottom: calc(1rem * var(--phi));
            font-style: italic;
            opacity: 0.7;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .typing-indicator.active { display: block; }
        
        .examples {
            margin-top: calc(1rem * var(--phi));
            padding: calc(1rem * var(--phi));
            background: rgba(0, 0, 0, 0.2);
            border-radius: calc(8px * var(--phi-inverse));
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .examples h3 {
            margin-bottom: calc(0.5rem * var(--phi));
            color: var(--accent);
            font-size: calc(1.2rem * var(--phi-inverse));
        }
        
        .example {
            padding: calc(0.5rem * var(--phi));
            margin-bottom: calc(0.5rem * var(--phi));
            background: rgba(255, 255, 255, 0.05);
            border-radius: calc(4px * var(--phi-inverse));
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .example:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent);
            transform: translateX(5px);
        }
        
        .aura-actions {
            display: flex;
            gap: calc(0.5rem * var(--phi));
            margin-top: calc(1rem * var(--phi));
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: calc(0.5rem * var(--phi)) calc(1rem * var(--phi));
            background: rgba(255, 215, 0, 0.1);
            color: var(--accent);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: calc(6px * var(--phi-inverse));
            cursor: pointer;
            transition: all 0.2s;
            font-size: calc(0.9rem / var(--phi));
        }
        
        .action-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .chat-container {
                padding: calc(0.5rem * var(--phi));
            }
            
            .message-content {
                max-width: 90%;
            }
            
            .aura-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            üåü AURA OSINT - Chat IA Qwen
        </div>
        <div class="status">
            <div class="status-indicator" id="status-indicator"></div>
            <span id="status-text">Connexion...</span>
        </div>
    </div>

    <div class="chat-container">
        <div class="messages-container" id="messages-container">
            <div class="message assistant">
                <div class="message-content">
                    üéØ Bonjour ! Je suis votre assistant IA AURA OSINT avec Qwen int√©gr√©. 
                    <br><br>
                    Je peux orchestrer <strong>17 outils OSINT op√©rationnels</strong> pour vos investigations :
                    <br>‚Ä¢ üì± Phone Intelligence (PhoneInfoga, PhoneNumbers)
                    <br>‚Ä¢ üßÖ Darknet & Security (OnionScan, TorBot) 
                    <br>‚Ä¢ üë§ Username Intelligence (Sherlock, Maigret)
                    <br>‚Ä¢ üåê Network Intelligence (Shodan, IP Lookup)
                    <br>‚Ä¢ üìß Email Intelligence (Holehe, Breach Check)
                    <br>‚Ä¢ üîç Domain Intelligence (Subfinder, Whois)
                    <br><br>
                    Que souhaitez-vous investiguer ?
                </div>
                <div class="message-info">AURA IA ‚Ä¢ Maintenant</div>
            </div>
        </div>

        <div class="typing-indicator" id="typing-indicator">
            ü§ñ L'IA Qwen analyse votre demande et s√©lectionne les outils appropri√©s...
        </div>

        <div class="input-container">
            <textarea class="message-input" id="message-input" placeholder="D√©crivez votre investigation OSINT..." rows="1"></textarea>
            <button class="send-button" id="send-button">üöÄ Analyser</button>
        </div>

        <div class="aura-actions">
            <button class="action-btn" onclick="showAuraAlerts()">üé® Alertes AURA</button>
            <button class="action-btn" onclick="showSystemStats()">üìä Statistiques</button>
            <button class="action-btn" onclick="showToolsSelector()">üõ†Ô∏è S√©lectionner Outils</button>
            <button class="action-btn" onclick="showConfiguration()">‚öôÔ∏è Configuration</button>
        </div>

        <div class="examples">
            <h3>üí° Exemples d'investigations :</h3>
            <div class="example">Analyse le profil LinkedIn de john.doe@company.com</div>
            <div class="example">Informations sur l'adresse IP 192.168.1.1 avec scan Shodan</div>
            <div class="example">V√©rifie si l'email example@domain.com a √©t√© compromis</div>
            <div class="example">Recherche username "target_user" sur tous les r√©seaux sociaux</div>
            <div class="example">Analyse le domaine suspicious-site.com avec √©num√©ration compl√®te</div>
            <div class="example">Investigation t√©l√©phone +33612345678 avec g√©olocalisation</div>
            <div class="example">Scan darknet pour le service .onion 3g2upl4pq6kufc4m.onion</div>
            <div class="example">Corr√©lation multi-sources pour l'identit√© "John Smith Paris"</div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = window.location.origin;
        const WS_URL = `ws://${window.location.host}`;
        
        // √âl√©ments DOM
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const typingIndicator = document.getElementById('typing-indicator');
        const examples = document.querySelectorAll('.example');
        
        // √âtat de la connexion
        let isConnected = false;
        let ws = null;
        
        // Initialiser SweetAlert2 avec th√®me AURA
        const AuraSwal = Swal.mixin({
            customClass: {
                confirmButton: 'aura-btn aura-btn-primary',
                cancelButton: 'aura-btn aura-btn-secondary',
                popup: 'aura-swal-popup'
            },
            buttonsStyling: false
        });
        
        // Initialiser la connexion WebSocket
        function initWebSocket() {
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = () => {
                    isConnected = true;
                    statusIndicator.classList.add('connected');
                    statusText.textContent = 'IA Connect√©e';
                    console.log('üîå WebSocket connect√© √† AURA AI Engine');
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'welcome') {
                        console.log('üéØ AURA AI Engine:', data.message);
                    } else if (data.type === 'chat_response') {
                        hideTypingIndicator();
                        addMessage(data.message, 'assistant', data.tools_selected);
                    } else if (data.type === 'tool_execution') {
                        showToolExecution(data.tool, data.status);
                    } else if (data.type === 'tool_result') {
                        showToolResult(data.tool, data.result);
                    } else if (data.type === 'error') {
                        hideTypingIndicator();
                        addMessage(data.message, 'assistant', null, true);
                    }
                };
                
                ws.onclose = () => {
                    isConnected = false;
                    statusIndicator.classList.remove('connected');
                    statusText.textContent = 'Reconnexion...';
                    console.log('üîå WebSocket d√©connect√©, tentative de reconnexion...');
                    setTimeout(initWebSocket, 3000);
                };
                
                ws.onerror = (error) => {
                    console.error('‚ùå Erreur WebSocket:', error);
                    statusText.textContent = 'Erreur de connexion';
                };
            } catch (error) {
                console.error('‚ùå Erreur initialisation WebSocket:', error);
                statusText.textContent = 'WebSocket indisponible';
            }
        }
        
        // Ajouter un message au chat
        function addMessage(content, sender, toolsUsed = null, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = content;
            
            if (isError) {
                messageContent.style.backgroundColor = 'rgba(255, 71, 87, 0.2)';
                messageContent.style.borderColor = 'rgba(255, 71, 87, 0.5)';
            }
            
            const messageInfo = document.createElement('div');
            messageInfo.className = 'message-info';
            messageInfo.textContent = `${sender === 'user' ? 'Vous' : 'AURA IA'} ‚Ä¢ ${new Date().toLocaleTimeString()}`;
            
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageInfo);
            
            // Ajouter les outils utilis√©s si disponibles
            if (toolsUsed && toolsUsed.length > 0) {
                const toolsDiv = document.createElement('div');
                toolsDiv.className = 'tools-used';
                toolsDiv.innerHTML = `
                    <h4>üõ†Ô∏è Outils OSINT utilis√©s :</h4>
                    ${toolsUsed.map(tool => `<div class="tool-result">üîç ${tool}</div>`).join('')}
                `;
                messageDiv.appendChild(toolsDiv);
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Afficher l'ex√©cution d'un outil
        function showToolExecution(toolName, status) {
            const executionDiv = document.createElement('div');
            executionDiv.className = 'message assistant';
            executionDiv.innerHTML = `
                <div class="message-content">
                    ‚ö° Ex√©cution de <strong>${toolName}</strong> en cours...
                </div>
                <div class="message-info">Outil OSINT ‚Ä¢ ${new Date().toLocaleTimeString()}</div>
            `;
            messagesContainer.appendChild(executionDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Afficher le r√©sultat d'un outil
        function showToolResult(toolName, result) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'message assistant';
            resultDiv.innerHTML = `
                <div class="message-content">
                    ‚úÖ <strong>${toolName}</strong> termin√©
                    <span class="confidence-score">${result.data.confidence_score}% confiance</span>
                    <div class="tools-used">
                        <div class="tool-result">
                            üìä ${result.data.findings}<br>
                            ‚è±Ô∏è Temps d'ex√©cution: ${result.execution_time}s
                        </div>
                    </div>
                </div>
                <div class="message-info">R√©sultat OSINT ‚Ä¢ ${new Date().toLocaleTimeString()}</div>
            `;
            messagesContainer.appendChild(resultDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Afficher/masquer l'indicateur de frappe
        function showTypingIndicator() {
            typingIndicator.classList.add('active');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function hideTypingIndicator() {
            typingIndicator.classList.remove('active');
        }
        
        // Envoyer un message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Ajouter le message de l'utilisateur
            addMessage(message, 'user');
            messageInput.value = '';
            
            // D√©sactiver le bouton pendant le traitement
            sendButton.disabled = true;
            sendButton.textContent = 'üîÑ Analyse...';
            
            // Afficher l'indicateur de frappe
            showTypingIndicator();
            
            try {
                // Envoyer via WebSocket si disponible
                if (isConnected && ws) {
                    ws.send(JSON.stringify({
                        type: 'chat',
                        message: message
                    }));
                } else {
                    // Fallback vers HTTP
                    const response = await fetch(`${API_URL}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    hideTypingIndicator();
                    addMessage(data.response, 'assistant', data.tools_used);
                    
                    // Afficher les r√©sultats des outils
                    if (data.tool_results && data.tool_results.length > 0) {
                        setTimeout(() => {
                            data.tool_results.forEach(result => {
                                showToolResult(result.tool, result);
                            });
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur envoi message:', error);
                hideTypingIndicator();
                addMessage('D√©sol√©, une erreur est survenue lors du traitement de votre demande. Veuillez r√©essayer.', 'assistant', null, true);
            } finally {
                // R√©activer le bouton
                sendButton.disabled = false;
                sendButton.textContent = 'üöÄ Analyser';
            }
        }
        
        // Fonctions SweetAlert2 int√©gr√©es
        async function showAuraAlerts() {
            await AuraSwal.fire({
                title: 'üé® Syst√®me d\'Alertes AURA',
                html: `
                    <div style="text-align: left;">
                        <p>üåü <strong>Th√®me Golden Ratio (Œ¶ = 1.618)</strong></p>
                        <p>‚ú® Animations fluides et harmonieuses</p>
                        <p>üéØ Alertes contextuelles pour investigations</p>
                        <p>üìä Indicateurs de progression en temps r√©el</p>
                        <p>üîî Notifications syst√®me int√©gr√©es</p>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: '‚úÖ Compris'
            });
        }
        
        async function showSystemStats() {
            await AuraSwal.fire({
                title: 'üìä Statistiques Syst√®me',
                html: `
                    <div style="text-align: left;">
                        <p>üõ†Ô∏è <strong>17 outils OSINT op√©rationnels</strong></p>
                        <p>üìà 68% de couverture des objectifs</p>
                        <p>üéØ 9 cat√©gories d'investigation</p>
                        <p>‚ö° Temps de r√©ponse moyen: 15s</p>
                        <p>üîå WebSocket temps r√©el actif</p>
                        <p>ü§ñ IA Qwen int√©gr√©e</p>
                    </div>
                `,
                icon: 'success',
                confirmButtonText: 'üìà Excellent'
            });
        }
        
        async function showToolsSelector() {
            await AuraSwal.fire({
                title: 'üõ†Ô∏è S√©lection Outils OSINT',
                html: `
                    <div style="text-align: left;">
                        <h4>üì± Phone Intelligence</h4>
                        <p>‚Ä¢ PhoneInfoga, PhoneNumbers</p>
                        <h4>üßÖ Darknet & Security</h4>
                        <p>‚Ä¢ OnionScan, TorBot</p>
                        <h4>üë§ Username Intelligence</h4>
                        <p>‚Ä¢ Sherlock (400+ sites), Maigret (2000+ sites)</p>
                        <h4>üåê Network Intelligence</h4>
                        <p>‚Ä¢ Shodan, IP Lookup, SSL Analyzer</p>
                        <h4>üìß Email Intelligence</h4>
                        <p>‚Ä¢ Holehe, H8Mail, Breach Check</p>
                    </div>
                `,
                width: '600px',
                confirmButtonText: 'üéØ Parfait'
            });
        }
        
        async function showConfiguration() {
            await AuraSwal.fire({
                title: '‚öôÔ∏è Configuration AURA',
                html: `
                    <div style="text-align: left;">
                        <p>üîå <strong>Backend:</strong> http://localhost:4011</p>
                        <p>üí¨ <strong>Chat IA:</strong> Qwen int√©gr√©</p>
                        <p>üåê <strong>WebSocket:</strong> ws://localhost:4011</p>
                        <p>üé® <strong>Th√®me:</strong> Golden Ratio</p>
                        <p>üîí <strong>S√©curit√©:</strong> Authentification ROOT</p>
                        <p>üìä <strong>Base de donn√©es:</strong> PostgreSQL + Elasticsearch</p>
                    </div>
                `,
                confirmButtonText: '‚ö° Optimal'
            });
        }
        
        // Gestionnaires d'√©v√©nements
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
        
        // Exemples de requ√™tes
        examples.forEach(example => {
            example.addEventListener('click', () => {
                messageInput.value = example.textContent.trim();
                messageInput.focus();
                messageInput.style.height = 'auto';
                messageInput.style.height = messageInput.scrollHeight + 'px';
            });
        });
        
        // Initialisation
        initWebSocket();
        
        // Test de connexion au backend
        fetch(`${API_URL}/api/health`)
            .then(response => response.json())
            .then(data => {
                console.log('üéØ AURA Backend connect√©:', data);
                statusText.textContent = 'Syst√®me Op√©rationnel';
            })
            .catch(error => {
                console.error('‚ùå Backend indisponible:', error);
                statusText.textContent = 'Backend indisponible';
            });
    </script>
</body>
</html>